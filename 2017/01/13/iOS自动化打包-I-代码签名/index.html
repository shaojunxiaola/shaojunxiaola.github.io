<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>iOS自动化打包(I):代码签名 | Xiao</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS自动化打包(I):代码签名</h1><a id="logo" href="/.">Xiao</a><p class="description">世界很美，而你正好有空</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS自动化打包(I):代码签名</h1><div class="post-meta">2017-01-13<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span></div><div class="post-content"><blockquote>
<p>大多数时候代码签名看上去就像是一个难以理解的神秘黑盒。最近在做iOS自动化打包，有许多相似但又不同的APP，一个个打包耗时挺长，浪费人力，如何“快速自动化生成”这样的需求也就应运而生了。</p>
</blockquote>
<p><strong>此篇是iOS自动化打包的第一篇，主要介绍一些重新签名需要了解的一些理论知识。</strong></p>
<ul>
<li>证书：内容是公钥或私钥，由其他机构对其签名组成的数据包;</li>
<li>Entitlements：包含了 App 权限开关列表;</li>
<li>CertificateSigningRequest：本地公钥;</li>
<li>p12：本地私钥，可以导入到其他电脑;</li>
<li>Provisioning Profile：包含了 证书 / Entitlements 等数据，并由苹果后台私钥签名的数据包;</li>
</ul>
<h3 id="一、证书和密匙"><a href="#一、证书和密匙" class="headerlink" title="一、证书和密匙"></a>一、证书和密匙</h3><p>iOS 开发者使用的 Mac 应该已经有一个证书，一个公钥，以及一个私钥。这些是代码签名机制的核心。</p>
<p>在 OS X 上，证书都是由一个叫钥匙串访问的工具来进行管理。打开 Mac 的钥匙串访问应用，选择类别选项下的“我的证书（My Certificates）”，你可以看到所有你持有的私钥相对应的证书。<a id="more"></a></p>
<p>私钥是你在为组成应用的二进制文件进行签名时派上用场的。没有私钥，你就无法用证书和公钥对任何东西设置签名。如果你拥有一个证书的私钥，你可以展开证书并将它的私钥显示出来：</p>
<p><img src="http://o9m8ylgtk.bkt.clouddn.com/Snip20170113_1.png" alt=""></p>
<p>一个证书是一个公钥加上许多附加信息，这些附加信息都是被某个认证机构（Certificate Authority 简称 CA）进行签名认证过的，认证这个证书中的信息是准确无误的。对于 iOS 开发来说这个认证机构就是苹果的认证部门 Apple Worldwide Developer Relations CA。</p>
<h3 id="二、授权机制"><a href="#二、授权机制" class="headerlink" title="二、授权机制"></a>二、授权机制</h3><p>授权机制决定了哪些系统资源在什么情况下允许被一个应用使用。简单的说它就是一个沙盒的配置列表，上面列出了哪些行为被允许，哪些会被拒绝。</p>
<p>Xcode 会将这个文件作为 - -entitlements 参数的内容传给 codesign ，这个文件内部格式如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;?xml</span> <span class="string">version="1.0"</span> <span class="string">encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">plist</span> <span class="string">PUBLIC</span> <span class="string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span><span class="string">&gt;</span></span><br><span class="line"><span class="string">&lt;plist</span> <span class="string">version="1.0"&gt;</span></span><br><span class="line"><span class="string">&lt;dict&gt;</span></span><br><span class="line">        <span class="string">&lt;key&gt;application-identifier&lt;/key&gt;</span></span><br><span class="line">        <span class="string">&lt;string&gt;Z48KTT3VSL.com.example.app&lt;/string&gt;</span></span><br><span class="line">        <span class="string">&lt;key&gt;aps-environment&lt;/key&gt;</span></span><br><span class="line">        <span class="string">&lt;string&gt;production&lt;/string&gt;</span></span><br><span class="line">        <span class="string">&lt;key&gt;com.apple.developer.team-identifier&lt;/key&gt;</span></span><br><span class="line">        <span class="string">&lt;string&gt;Z48KTT3VSL&lt;/string&gt;</span></span><br><span class="line">        <span class="string">&lt;key&gt;get-task-allow&lt;/key&gt;</span></span><br><span class="line">        <span class="string">&lt;false/&gt;</span></span><br><span class="line"><span class="string">&lt;/dict&gt;</span></span><br><span class="line"><span class="string">&lt;/plist&gt;</span></span><br></pre></td></tr></table></figure>

<p>查看授权信息：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">codesign</span> <span class="string">-d</span> <span class="string">--entitlements</span> <span class="bullet">-</span> <span class="string">Example.app</span></span><br></pre></td></tr></table></figure>

<p>在 Xcode 的 Capabilities 选项卡下选择一些选项之后，会自动生成一个XML格式 .entitlements 文件，然后在需要的时候往里面添加条目。当构建整个应用时，这个文件也会提交给 codesign 作为应用所需要拥有哪些授权的参考。这些授权信息必须都在开发者中心的 App ID 中启用，并且包含在配置文件中。在构建应用时需要使用的授权文件可以在 Xcode build setting 中的 code signing entitlements 中设置。</p>
<h3 id="三、配置文件"><a href="#三、配置文件" class="headerlink" title="三、配置文件"></a>三、配置文件</h3><p>在整个代码签名和沙盒机制中有一个组成部分将签名，授权和沙盒联系了起来，那就是配置文件 (provisioning profiles)。</p>
<p>一个配置文件是一组信息的集合，这组信息决定了某一个应用是否能够在某一个特定的设备上运行。配置文件可以用于让应用在你的开发设备上可以被运行和调试，也可以用于内部测试 (ad-hoc) 或者企业级应用的发布。同一个证书可以拥有多个不同的配置文件，Xcode 会将你在 project setting 中选择的配置文件打包进应用。</p>
<p>配置文件存放路径：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">~/Library/MobileDevice/Provisioning</span> <span class="string">Profiles</span></span><br></pre></td></tr></table></figure>

<p>配置文件是一个根据密码讯息语法 (Cryptographic Message Syntax) 加密的文件（下文中会简称 CMS）。采用 CMS 格式进行加密使得配置文件可以被设置签名，所以在苹果给你这个文件之后文件就不能被改变了。配置文件的签名和应用的签名不是一回事，它是由苹果直接在开发者中心 (developer portal) 中设置好了的。</p>
<p>幸运的是命令行工具 security 也可以解码这个 CMS 格式：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">security</span> <span class="string">cms</span> <span class="string">-D</span> <span class="string">-i</span> <span class="string">example.mobileprovision</span></span><br></pre></td></tr></table></figure>

<p>这个命令会输出签名信息中的内容，一个 XML 格式的 plist 文件。列表中的内容是 iOS 用于判断你的应用是否能运行在某个设备上真正需要的配置信息，每一个配置文件都有它自己的 UUID 。Xcode 会用这个 UUID 来作为标识，记录你在 build settings 中选择了哪一个配置文件。</p>
<p>文件内容都是以键值对（Key-Value）的形式展示的：</p>
<ul>
<li>DeveloperCertificates：这一项是一个列表，包含了可以为使用这个配置文件的应用签名的所有证书。如果你用了一个不在这个列表中的证书进行签名，无论这个证书是否有效，这个应用就无法运行；</li>
<li>Entitlements：对应的 Value 是一个字典，包含了应用的所有授权信息，键值就和之前在授权那节看到的一模一样（正常情况下一模一样）。</li>
</ul>
<h3 id="四、重新签名"><a href="#四、重新签名" class="headerlink" title="四、重新签名"></a>四、重新签名</h3><p>我们知道苹果在打包的最后步骤就是进行签名，如果对于一个已经签名的包，我们还可以进行重新签名，签名的命令主要是 <strong>codesign</strong> </p>
<p>设置签名：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">codesign</span> <span class="string">-s</span> <span class="string">'iPhone Distribution: Hangzhou ChuangJiang Technology Co., Ltd. (P7KXERWG7Q)'</span> <span class="string">Example.app</span></span><br></pre></td></tr></table></figure>

<p>如果你想为某一个 app 程序包重新设置签名，你必须带上 -f 参数，有了这个参数，codesign 会用你选择的签名替换掉已经存在的那一个。</p>
<p>重新签名：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">codesign</span> <span class="string">-f</span> <span class="string">-s</span> <span class="string">'iPhone Distribution: Hangzhou ChuangJiang Technology Co., Ltd. (P7KXERWG7Q)'</span> <span class="string">Example.app</span></span><br></pre></td></tr></table></figure>

<p>列出一些有关 Example.app的签名信息： </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">codesign</span> <span class="string">-vv</span> <span class="string">-d</span> <span class="string">Example.app</span></span><br></pre></td></tr></table></figure>

<p>签名信息:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Identifier=com.chuangjiang.app</span></span><br><span class="line"><span class="string">Format=app</span> <span class="string">bundle</span> <span class="string">with</span> <span class="string">Mach-O</span> <span class="string">universal</span> <span class="string">(armv7</span> <span class="string">arm64)</span></span><br><span class="line"><span class="string">CodeDirectory</span> <span class="string">v=20200</span> <span class="string">size=33048</span> <span class="string">flags=0x0(none)</span> <span class="string">hashes=1025+5</span> <span class="string">location=embedded</span></span><br><span class="line"><span class="string">Signature</span> <span class="string">size=4763</span></span><br><span class="line"><span class="string">Authority=iPhone</span> <span class="attr">Distribution:</span> <span class="string">Hangzhou</span> <span class="string">ChuangJiang</span> <span class="string">Technology</span> <span class="string">Co.,</span> <span class="string">Ltd.</span> <span class="string">(P7KXERWG7Q)</span></span><br><span class="line"><span class="string">Authority=Apple</span> <span class="string">Worldwide</span> <span class="string">Developer</span> <span class="string">Relations</span> <span class="string">Certification</span> <span class="string">Authority</span></span><br><span class="line"><span class="string">Authority=Apple</span> <span class="string">Root</span> <span class="string">CA</span></span><br><span class="line"><span class="string">Signed</span> <span class="string">Time=2017年1月13日</span> <span class="string">上午11:45:17</span></span><br><span class="line"><span class="string">Info.plist</span> <span class="string">entries=39</span></span><br><span class="line"><span class="string">TeamIdentifier=P7KXERWG7Q</span></span><br><span class="line"><span class="string">Sealed</span> <span class="string">Resources</span> <span class="string">version=2</span> <span class="string">rules=13</span> <span class="string">files=205</span></span><br><span class="line"><span class="string">Internal</span> <span class="string">requirements</span> <span class="string">count=1</span> <span class="string">size=216</span></span><br></pre></td></tr></table></figure>

<p>主要关注以 Authority 开头的那三行。这三行告诉你到底是哪一个证书（iPhone Distribution: Hangzhou ChuangJiang Technology Co., Ltd. (P7KXERWG7Q)）为这个 app 设置了签名。这个证书则是被 Apple Worldwide Developer Relations Certification Authority 设置了签名的，依此类推这个证书则是被证书 Apple Root CA 设置了签名。</p>
<p>Identifier 是在 Xcode 中设置的 Bundle identifier。TeamIdentifier 用于标识工作组（系统会用这个来判断应用是否是由同一个开发者发布）。</p>
<p>验证签名是否完好，若无任何输出则说明签名完好</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">codesign</span> <span class="string">--verify</span> <span class="string">Example.app</span></span><br></pre></td></tr></table></figure>

<p>在 iOS 和 OS X 的应用和框架中，可执行文件和包含其中的资源都需要设置签名。这些资源包括图片和不同的语言文件，也包括很重要的应用组成部分例如 XIB/NIB 文件，存档文件(archives)，甚至是证书文件。所以为一个程序包设置签名时，这个包中的所有资源文件也都会被设置签名。</p>
<p>为了达到为所有文件设置签名的目的，签名的过程中会在程序包中新建一个叫做 _CodeSignatue/CodeResources 的文件，这个文件中存储了被签名的程序包中所有文件的签名。</p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2017/01/15/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%9B%B8%E5%85%B3%E6%96%87%E7%AB%A0/">小程序相关文章</a><a class="next" href="/2017/01/05/CAReplicatorLayer%E7%AE%80%E4%BB%8B/">CAReplicatorLayer简介</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Apple/">Apple</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Document/">Document</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Fastlane/">Fastlane</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Reader/">Reader</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Core-Animation/" style="font-size: 15px;">Core Animation</a> <a href="/tags/Tips/" style="font-size: 15px;">Tips</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/JSPatch/" style="font-size: 15px;">JSPatch</a> <a href="/tags/blueprint/" style="font-size: 15px;">blueprint</a> <a href="/tags/Base/" style="font-size: 15px;">Base</a> <a href="/tags/%E5%9F%8B%E7%82%B9/" style="font-size: 15px;">埋点</a> <a href="/tags/Xcode/" style="font-size: 15px;">Xcode</a> <a href="/tags/UDID/" style="font-size: 15px;">UDID</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/26/fastlane-cert/">自动化配置iOS开发者证书</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/17/APP-Download-Link/">APP Download Link</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/26/Transporter-Error-Output/">Transporter Error Output</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/18/Byte-array-to-UIImage/">Byte数组转化为UIImage</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/16/iOS-YTKNetwork-HTTPS/">iOS YTKNetwork 适配 HTTPS</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/16/iOS-AFNetworking-HTTPS/">iOS AFNetworking 适配 HTTPS</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/31/%E4%BD%BF%E7%94%A8Shell%E8%84%9A%E6%9C%AC%E6%89%B9%E9%87%8F%E5%8E%8B%E7%BC%A9%E5%9B%BE%E7%89%87/">使用Shell脚本批量压缩图片</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/Objective-C-Coding-Guidelines/">Objective-C Coding Guidelines</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/11/%E9%82%93%E7%99%BD%E6%B0%8F%E7%A0%81%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2/">邓白氏码信息查询</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Xiao.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>